---
title: "HW_1_Yeonji_Frankie_Ofer"
output: pdf_document
---

```{r}
#Loading relevant libraries
library(tidyverse)
library(lubridate)

#Loading filtered data files
trips <- read_csv("trips_hw_1.csv")
fares <- read_csv("fares_hw_1.csv")

#Converting to tibbles
trips <- as.tibble(trips)
fares <- as.tibble(fares)
```

## Data Cleaning
### Trips tibble cleaning

```{r}
#Limiting passanger count to between 1 and 6
trips <- filter(trips, between(trips$passenger_count,1,6))
#Removing 0 value distances
trips <- filter(trips, trips$trip_distance>0)
#filtering trip time in secs between 60 seconds to 7200 seconds (2 hours)
trips <- filter(trips, between(trips$trip_time_in_secs,60,7200))
#checking trip time in seconds using the pickup and dropoff datetimes 
#removing all observations in which there is a difference of over 10 seconds
trips<- trips %>% 
  mutate(time_diff=as.duration(dropoff_datetime-pickup_datetime)) %>% 
  mutate(different=abs(time_diff-as.duration(trips$trip_time_in_secs))>as.duration(10)) %>% 
  filter(!different)
#limiting fare codes to 1-6
trips <- filter(trips, between(trips$rate_code,1,6))
#removing irrelevant columns
trips <- select(trips, -vendor_id,-store_and_fwd_flag, -c(11:16))
View(trips)
```

### Fares file cleaning
```{r}
#Only consider data with cash or credit card payment
fares <- filter(fares, payment_type %in% c('CRD', 'CSH'))
#Remove data with fare amount less than 0.5
fares <- filter(fares, fare_amount >= 0.5)
#Remove data which tip amount is more than 50% of fare amount
fares <- filter(fares, tip_amount/fare_amount < 0.5)
#Remove data with discrepancy between calculated total amount and total_amount
fares <- filter(fares, fare_amount+surcharge+mta_tax+tip_amount+tolls_amount==total_amount)
#Remove vendor_id column
fares <- select(fares, -vendor_id)
View(fares)
```


### Join Trips and Fares
```{r}
#Check for key for trips
trips %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#Check for key for fares
fares %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#check specific fare entry
fares %>% filter(medallion==2013000386,hack_license==2013000384,pickup_datetime==ymd_hms(20130815171800))

#Remove duplicate rows
distinct(trips)
distinct(fares)

#Only keep the rows with higher total_amount 
fares <- fares %>% arrange(desc(total_amount)) %>% distinct(medallion, hack_license, pickup_datetime, .keep_all = TRUE)

#Join trips and fares
taxi_data <- inner_join(trips,fares)
```

# Part E
```{r}
# i) Add column for total trips
medallion_data <- taxi_data %>% group_by(medallion) %>% mutate(total_trips = n())

# ii) Add column for total passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_passengers = sum(passenger_count))

# iii) Add column for total time with passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_time_with_passengers = sum(trip_time_in_secs))

# iii) Add column for total time with passengers with 8/16 cutoff
cutoff = ymd_hms("2013-08-16 00:00:00")

medallion_data <- medallion_data %>% mutate(trip_time_on_next_day = ifelse( as.numeric(difftime(cutoff,dropoff_datetime,units="secs"))<0,as.numeric(difftime(cutoff,dropoff_datetime,units="secs")),0)) %>% group_by(medallion) %>% mutate(total_time_with_passengers_2 = sum(trip_time_in_secs+trip_time_on_next_day))

# iv) Add column for total distance traveled
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_distance = sum(trip_distance))

# v) Add column for total earnings
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_earnings = sum(total_amount))

# Remove irrelevant columns
medallion_data <- select(medallion_data, -(hack_license:total_amount),-trip_time_on_next_day)



```
# Part F
```{r}

```


# Part G
```{r}

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
