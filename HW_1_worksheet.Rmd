---
title: "HW_1_Yeonji_Frankie_Ofer"
output: pdf_document
---

```{r}
#Loading relevant libraries
library(tidyverse)
library(lubridate)
library(ggplot2)

#Loading filtered data files
trips <- read_csv("trips_hw_1.csv")
fares <- read_csv("fares_hw_1.csv")

#Converting to tibbles
trips <- as.tibble(trips)
fares <- as.tibble(fares)
```

## Data Cleaning
### Trips tibble cleaning

```{r}
#Limiting passanger count to between 1 and 6
trips <- filter(trips, between(trips$passenger_count,1,6))
#Removing 0 value distances and limiting trip distance to 500 miles
trips <- filter(trips, between(trips$trip_distance,0,500))
#filtering trip time in secs between 60 seconds to 7200 seconds (2 hours)
trips <- filter(trips, between(trips$trip_time_in_secs,60,7200))
#checking trip time in seconds using the pickup and dropoff datetimes 
#removing all observations in which there is a difference of over 10 seconds
trips<- trips %>% 
  mutate(time_diff=as.duration(dropoff_datetime-pickup_datetime)) %>% 
  mutate(different=abs(time_diff-as.duration(trips$trip_time_in_secs))>as.duration(10)) %>% 
  filter(!different)
#limiting fare codes to 1-6
trips <- filter(trips, between(trips$rate_code,1,6))
#removing irrelevant columns
trips <- select(trips, -vendor_id,-store_and_fwd_flag, -c(11:16))
View(trips)
```

### Fares file cleaning
```{r}
#Only consider data with cash or credit card payment
fares <- filter(fares, payment_type %in% c('CRD', 'CSH'))
#Remove data with fare amount less than 0.5
fares <- filter(fares, fare_amount >= 0.5)
#Remove data which tip amount is more than 50% of fare amount
fares <- filter(fares, tip_amount/fare_amount < 0.5)
#Remove data with discrepancy between calculated total amount and total_amount
fares <- filter(fares, fare_amount+surcharge+mta_tax+tip_amount+tolls_amount==total_amount)
#Remove vendor_id column
fares <- select(fares, -vendor_id)
View(fares)
```


### Join Trips and Fares
```{r}
#Check for key for trips
trips %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#Check for key for fares
fares %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#check specific fare entry
fares %>% filter(medallion==2013000386,hack_license==2013000384,pickup_datetime==ymd_hms(20130815171800))

#Remove duplicate rows
distinct(trips)
distinct(fares)

#Only keep the rows with higher total_amount 
fares <- fares %>% arrange(desc(total_amount)) %>% distinct(medallion, hack_license, pickup_datetime, .keep_all = TRUE)

#Join trips and fares
taxi_data <- inner_join(trips,fares)
```

# Part E
```{r}
# i) Add column for total trips
medallion_data <- taxi_data %>% group_by(medallion) %>% mutate(total_trips = n())

# ii) Add column for total passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_passengers = sum(passenger_count))

# iii) Add column for total time with passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_time_with_passengers = sum(trip_time_in_secs))

# iii) Add column for total time with passengers with 8/16 cutoff
cutoff = ymd_hms("2013-08-16 00:00:00")

medallion_data <- medallion_data %>% mutate(trip_time_on_next_day = ifelse( as.numeric(difftime(cutoff,dropoff_datetime,units="secs"))<0,as.numeric(difftime(cutoff,dropoff_datetime,units="secs")),0)) %>% group_by(medallion) %>% mutate(total_time_with_passengers_2 = sum(trip_time_in_secs+trip_time_on_next_day))

# iv) Add column for total distance traveled
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_distance = sum(trip_distance))

# v) Add column for total earnings
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_earnings = sum(total_amount))

# Select relevant columns for the final output
partE_temp <- select(medallion_data, c(medallion, total_trips, total_passengers, total_time_with_passengers, total_distance, total_earnings))

# Remove the duplicated rows; Make a list of taxicab
partE_output <- partE_temp %>% distinct(partE_temp, medallion, .keep_all=T)

```
# Part F
```{r}

# Add column for hour 
add_hour <- medallion_data %>% mutate(hours=format(as.POSIXct(pickup_datetime, format="%Y-%m-%d %H:%M"), format="%H") )

# i) Add column for total passengers picked up
partFi <- add_hour %>% group_by(hack_license, hours) %>%  mutate(total_passengers_picked_up = sum(passenger_count))

# ii) Add column for trips started
partFii <- partFi %>% group_by(hack_license, hours) %>%  mutate(trips_started = n())

# Select relevant columns for the final output
partF_temp <- select(partFii, c(hack_license, hours, total_passengers_picked_up, trips_started))

# Remove the duplicated rows; Make a list of taxicab
partF_output <- partF_temp %>% distinct(partF_temp, hack_license, .keep_all=T)

```


# Part G
```{r}

taxi_data <- taxi_data %>% 
  #Extracting hours
  mutate(pickup_hour_time = as.integer(format(pickup_datetime,format='%H'))) %>%
  mutate(dropoff_hour_time = as.integer(format(dropoff_datetime,format='%H'))) %>%
  #Boolean for same hour rides and creating two columns for later use of adjusted pickup and dropoff times
  mutate(adjusted_pickup_time=pickup_datetime) %>% 
  mutate(adjusted_dropoff_time=dropoff_datetime) 

# Separating to three tables, one with same hour rides, a second with rides that span two hours of the day and a 
# third with rides spanning 3 hours of the day, manually adding trips that end the next day
within_hour_rides <-filter(taxi_data, pickup_hour_time==dropoff_hour_time)
one_hour_diff <- rbind(filter(taxi_data, dropoff_hour_time==pickup_hour_time+1), 
                       filter(taxi_data, pickup_hour_time==23 & dropoff_hour_time==0)) 
two_hour_diff <- rbind(filter(taxi_data, dropoff_hour_time==pickup_hour_time+2),
                       filter(taxi_data, pickup_hour_time==22 & dropoff_hour_time==0),
                       filter(taxi_data, pickup_hour_time==23 & dropoff_hour_time==1))  
#Duplicating each row in the drives that span 2 hours of the day and adjusting the pickup and dropoff times for those
one_hour_diff_dup <- rbind(one_hour_diff %>% 
               mutate(adjusted_dropoff_time=ceiling_date(pickup_datetime, unit = "hours",change_on_boundary = FALSE)),
      one_hour_diff %>% 
        mutate(adjusted_pickup_time=floor_date(dropoff_datetime, unit = "hours")))

#Duplicating each row in the drives that span 3 hours of the day and adjusting the pickup and dropoff times for those

two_hour_diff_dup <- rbind(two_hour_diff %>% 
        mutate(adjusted_dropoff_time=ceiling_date(pickup_datetime, unit = "hours",change_on_boundary = FALSE)),
      two_hour_diff %>% 
        mutate(adjusted_pickup_time=floor_date(dropoff_datetime, unit = "hours")),
      two_hour_diff %>% 
        mutate(adjusted_dropoff_time=floor_date(dropoff_datetime, unit = "hours")) %>% 
        mutate(adjusted_pickup_time=ceiling_date(pickup_datetime, unit = "hours",change_on_boundary = FALSE)))

# Spot checking shows that for every rides spanning two hours we now have two rides, one ending at the turn of the hour and another starting at the turn of the hour. Same applies for rides spanning more than 2 hours of the day where the "middle" ride is a full hour ride.
# Combining all three tables and removing "rides" that have an adjusted start time on the next day
Duplicated_rides <- rbind(within_hour_rides,one_hour_diff_dup,two_hour_diff_dup)
Duplicated_rides <- filter(Duplicated_rides, format(adjusted_pickup_time,format='%Y:%m:%d')!='2013-08-15')                   
# Creating the relevant variables
Duplicated_rides <- Duplicated_rides %>% 
  mutate(adj_trip_time_in_secs = as.duration(adjusted_dropoff_time-adjusted_pickup_time)) %>% 
  mutate(average_speed = as.numeric(trip_distance/trip_time_in_secs)) %>% 
  mutate(adj_trip_dist = as.numeric(average_speed*adj_trip_time_in_secs)) %>% 
  mutate(adj_total_fare = as.numeric(total_amount*adj_trip_time_in_secs/trip_time_in_secs)) %>% 
  mutate(adj_pickup_hour = as.integer(format(pickup_datetime,format='%H')))

#Grouping and summarising the requested results
partG_output <- Duplicated_rides %>% 
  group_by(hack_license,adj_pickup_hour) %>% 
  summarise(sum(adj_trip_time_in_secs),sum(adj_trip_dist),sum(adj_total_fare))

names(partG_output) <- c("hack_license","hour","total_time_with_passengers","miles_with_passengers","earnings")
View(partG_output)

```


## Plotting 1

```{r}

#Creating a table grouped by hour of day for analysis
Per_hour_stats <- partG_output %>% group_by(hour) %>% summarise(mean(total_time_with_passengers), mean(miles_with_passengers), mean(earnings),n())
names(Per_hour_stats) <- c("hour","avg_time_with_passenegers","avg_miles_with_passenegers","avg_earnings","total_rides")
#creating two new variables for analysis
Per_hour_stats <- mutate(Per_hour_stats,avg_per_mile_earnings = avg_earnings/avg_miles_with_passenegers)
Per_hour_stats <- mutate(Per_hour_stats,avg_per_second_earnings = avg_earnings/avg_time_with_passenegers)

#Plotting the hour of day stats
ggplot(data = Per_hour_stats) + 
  geom_point(mapping = aes(x = hour, y = total_rides))

ggplot(data = Per_hour_stats) + 
  geom_point(mapping = aes(x = hour, y = avg_per_mile_earnings))

ggplot(data = Per_hour_stats) + 
  geom_point(mapping = aes(x = hour, y = avg_per_second_earnings))

```

### Plotting 1 Analysis
We created three scatter plots to analyse the rides patterns according to hour of the day on that specific date. We found that when looking at total number of rides per hour we see a rather steady high demand during the daytime between the hours of 8am and 2 pm, followed by a small decrease in demand for rides until 5pm. The demand for rides then climbs back up to reach a maximum of almost 12,000 at 7pm and steadily decreases until midnight. The demand for rides 2am and 5am is significantly lower as to be expected.

When looking at average per mile earnings we find that at 7pm a cab driver (on that day) will make on average about 6 dollars per mile (makes you think twice before taking a cab on that hour), while the minimum is at 5am in which traffic is virtually non-existent and the average per mile earning drops to about 4 dollars.

Contrasted with average earnings per second spent with passengers, we see that 5am is actually the maximum with earnings of about 3 cents per second spent with passengers while 7pm which is the most lucrative hour per mile is somewhere between 1.5 cents per second and 2 cents per second.


## Plotting 2

```{r}
#Making plots with the frequency for (a) total earnings and (b) total trips, total distance, total time.

ggplot(partE_output, aes(x = total_earnings, y = total_trips)) +
  geom_bin2d(bins = 40)

ggplot(partE_output, aes(x = total_earnings, y = total_time_with_passengers)) +
  geom_bin2d(bins = 40)

ggplot(partE_output, aes(x = total_earnings, y = total_distance)) +
  geom_bin2d(bins = 40)
```

### Plotting 2 Analysis
We also tried to just check whether total earnings actually relate to total trips, distance, and time. We created three scatter plots with geom_bin2d function by adding a heat map of 2d bin counts, which is easier for us to see the relationship considering the frequency. 

When looking at the total trips and earnings together, we found that getting more money naturally related to the number of trips the drivers had on that day. The plot showed a positive correlation between two variables. We were also able to check the distribution of both earnings and trips on that day, showing that there were many drivers who got around $500 to $625 with around 40 trips on that day. 

Similar as the prior plot, the plot of total earnings and times showed a positive relationship. It showed that as the driver got more money on that day, they spent more time on carrying passengers. For the distribution of both earnings and times on that day, it seemed that there were many drivers who earned around $500 and $700 by spending around 30,000 seconds carrying passengers on that day.

When examining the relationship between total earnings and distance, however, it seems that those two variables were not much related to each other. Because of some outliers, the plot had a kind of maximum of y axis, not showing clear patterns of their relationships b. Across the total earnings the drivers made on that day, the total distance varied a lot as shown as a “line” of the relationship between two variables. With the further assignment of the limit to the maximum value of y axis or deleting the outliers, the plot would show more clear pattern of the relationship. 

## Plotting 3

```{r}

ggplot(data = Per_hour_stats) + geom_point(mapping = aes(x = hour, y=avg_time_with_passenegers))

ggplot(data = Per_hour_stats) + geom_point(mapping = aes(x = hour, y=avg_earnings))

ggplot(data = partG_output) + geom_point(mapping = aes(x = total_time_with_passengers, y=earnings)) + geom_smooth(aes(x =total_time_with_passengers, y = earnings)) + facet_wrap(~hour, nrow = 4)

```

### Plotting 3 Analysis

We have shown there is a positive correlation between time with passengers and earnings from the plot above. When we further examine relationship between average timewith passengers and hour of day, we notice there is a sharp increase in time with passengers from 5am to 8am. Time  with passengers also gradually increases from 10am to 6pm to reach its highest point at around 2349 seconds. It then decreases significant from 6pm to 5am until it reaches its lowest point at around 1039 seconds. Whe we compare this plot with the plot using hour of day and average earnings, it reveals a similar pattern as hour of day and time with passengers except the discrepency between 9pm to 11pm and 3am to 5am where time with passengers decreases while earnings increases in that period. 

We then examine the relationship between time with passengers, hour of day and earnings from Part G output. We notice the plots of most of the hours suggest a linear relationship between time with passengers and earnings. However, some plots  (for instance 12am, 3am and 1pm) reveal the existance of potential outliers that requires our further investigation. 



