---
title: "HW_1_Yeonji_Frankie_Ofer"
output: pdf_document
---

```{r}
#Loading relevant libraries
library(tidyverse)
library(lubridate)

#Loading filtered data files
trips <- read_csv("trips_hw_1.csv")
fares <- read_csv("fares_hw_1.csv")

#Converting to tibbles
trips <- as.tibble(trips)
fares <- as.tibble(fares)
```

## Data Cleaning
### Trips tibble cleaning

```{r}
#Limiting passanger count to between 1 and 6
trips <- filter(trips, between(trips$passenger_count,1,6))
#Removing 0 value distances
trips <- filter(trips, trips$trip_distance>0)
#filtering trip time in secs between 60 seconds to 7200 seconds (2 hours)
trips <- filter(trips, between(trips$trip_time_in_secs,60,7200))
#checking trip time in seconds using the pickup and dropoff datetimes 
#removing all observations in which there is a difference of over 10 seconds
trips<- trips %>% 
  mutate(time_diff=as.duration(dropoff_datetime-pickup_datetime)) %>% 
  mutate(different=abs(time_diff-as.duration(trips$trip_time_in_secs))>as.duration(10)) %>% 
  filter(!different)
#limiting fare codes to 1-6
trips <- filter(trips, between(trips$rate_code,1,6))
#removing irrelevant columns
trips <- select(trips, -vendor_id,-store_and_fwd_flag, -c(11:16))
View(trips)
```

### Fares file cleaning
```{r}
#Only consider data with cash or credit card payment
fares <- filter(fares, payment_type %in% c('CRD', 'CSH'))
#Remove data with fare amount less than 0.5
fares <- filter(fares, fare_amount >= 0.5)
#Remove data which tip amount is more than 50% of fare amount
fares <- filter(fares, tip_amount/fare_amount < 0.5)
#Remove data with discrepancy between calculated total amount and total_amount
fares <- filter(fares, fare_amount+surcharge+mta_tax+tip_amount+tolls_amount==total_amount)
#Remove vendor_id column
fares <- select(fares, -vendor_id)
View(fares)
```


### Join Trips and Fares
```{r}
#Check for key for trips
trips %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#Check for key for fares
fares %>% count(medallion, hack_license, pickup_datetime) %>% filter(n>1)
#check specific fare entry
fares %>% filter(medallion==2013000386,hack_license==2013000384,pickup_datetime==ymd_hms(20130815171800))

#Remove duplicate rows
distinct(trips)
distinct(fares)

#Only keep the rows with higher total_amount 
fares <- fares %>% arrange(desc(total_amount)) %>% distinct(medallion, hack_license, pickup_datetime, .keep_all = TRUE)

#Join trips and fares
taxi_data <- inner_join(trips,fares)
```

# Part E
```{r}
# i) Add column for total trips
medallion_data <- taxi_data %>% group_by(medallion) %>% mutate(total_trips = n())

# ii) Add column for total passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_passengers = sum(passenger_count))

# iii) Add column for total time with passengers
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_time_with_passengers = sum(trip_time_in_secs))

# iii) Add column for total time with passengers with 8/16 cutoff
cutoff = ymd_hms("2013-08-16 00:00:00")

medallion_data <- medallion_data %>% mutate(trip_time_on_next_day = ifelse( as.numeric(difftime(cutoff,dropoff_datetime,units="secs"))<0,as.numeric(difftime(cutoff,dropoff_datetime,units="secs")),0)) %>% group_by(medallion) %>% mutate(total_time_with_passengers_2 = sum(trip_time_in_secs+trip_time_on_next_day))

# iv) Add column for total distance traveled
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_distance = sum(trip_distance))

# v) Add column for total earnings
medallion_data <- medallion_data %>% group_by(medallion) %>% mutate(total_earnings = sum(total_amount))

# Select relevant columns for the final output
partE_temp <- select(medallion_data, c(medallion, total_trips, total_passengers, total_time_with_passengers, total_distance, total_earnings))

# Remove the duplicated rows; Make a list of taxicab
partE_output <- partE_temp %>% distinct(partE_temp, medallion, .keep_all=T)

```
# Part F
```{r}

# Add column for hour 
add_hour <- medallion_data %>% mutate(hours=format(as.POSIXct(pickup_datetime, format="%Y-%m-%d %H:%M"), format="%H") )

# i) Add column for total passengers picked up
partFi <- add_hour %>% group_by(hack_license, hours) %>%  mutate(total_passengers_picked_up = sum(passenger_count))

# ii) Add column for trips started
partFii <- partFi %>% group_by(hack_license, hours) %>%  mutate(trips_started = n())

# Select relevant columns for the final output
partF_temp <- select(partFii, c(hack_license, hours, total_passengers_picked_up, trips_started))

# Remove the duplicated rows; Make a list of taxicab
partF_output <- partF_temp %>% distinct(partF_temp, hack_license, .keep_all=T)

```


## Plotting 2

```{r}
ggplot(partE_output, aes(x = total_earnings, y = total_trips)) +
  geom_bin2d(bins = 40)

ggplot(partE_output, aes(x = total_earnings, y = total_time_with_passengers)) +
  geom_bin2d(bins = 40)

ggplot(partE_output, aes(x = total_earnings, y = total_distance)) +
  geom_bin2d(bins = 40)
```

###Findings from Plotting 2
We also tried to just check whether total earnings actually relate to total trips, distance, and time. We created three scatter plots with geom_bin2d function by adding a heat map of 2d bin counts, which is easier for us to see the relationship considering the frequency. 

When looking at the total trips and earnings together, we found that getting more money naturally related to the number of trips the drivers had on that day. The plot showed a positive correlation between two variables. We were also able to check the distribution of both earnings and trips on that day, showing that there were many drivers who got around $500 to $625 with around 40 trips on that day. 

Similar as the prior plot, the plot of total earnings and times showed a positive relationship. It showed that as the driver got more money on that day, they spent more time on carrying passengers. For the distribution of both earnings and times on that day, it seemed that there were many drivers who earned around $500 and $700 by spending around 30,000 seconds carrying passengers on that day.

When examining the relationship between total earnings and distance, however, it seems that those two variables were not much related to each other. Because of some outliers, the plot had a kind of maximum of y axis, not showing clear patterns of their relationships b. Across the total earnings the drivers made on that day, the total distance varied a lot as shown as a “line” of the relationship between two variables. With the further assignment of the limit to the maximum value of y axis or deleting the outliers, the plot would show more clear pattern of the relationship. 
